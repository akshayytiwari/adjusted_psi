"0","psi_mc <- function(data, n_iter) {"
"0","  # Pre-allocate output"
"0","  n_rows <- nrow(data)"
"0","  results <- data.frame("
"0","    study = data$study,"
"0","    psi_l = NA_real_,"
"0","    psi_median = NA_real_,"
"0","    psi_u = NA_real_"
"0","  )"
"0","  "
"0","  # Vectorized Monte Carlo per-row"
"0","  for (i in 1:n_rows) {"
"0","    # Vectorized sampling"
"0","    alpha <- rbeta(n_iter, data$alpha_a[i], data$alpha_b[i])"
"0","    beta  <- rbeta(n_iter, data$beta_a[i],  data$beta_b[i])"
"0","    rho_c <- rbinom(n_iter, data$n[i],    data$rho_c[i]) / data$n[i]"
"0","    psi_c <- rbinom(n_iter, data$sp[i],   data$psi_c[i]) / data$sp[i]"
"0","    phi_c <- rbinom(n_iter, data$sn[i],   data$phi_c[i]) / data$sn[i]"
"0",""
"0","    # Calculations (all vectorized)"
"0","    num <- rho_c * (1 - rho_c) * (psi_c - 1 + phi_c) * (alpha + beta - 1)"
"0","    denom <- (rho_c + beta - 1) * (psi_c * rho_c * (1 - alpha) - alpha * (1 - phi_c) * (1 - rho_c))"
"0","    denom[abs(denom) < 1e-8] <- NA # Avoid instability"
"0","    "
"0","    rho_temp <- (rho_c + beta - 1) / (alpha + beta - 1)"
"0","    rho_temp[is.na(rho_temp) | (rho_temp < 0) | (rho_temp > 1)] <- NA"
"0","    "
"0","    psi_temp <- 1 - num / denom"
"0","    psi_temp[is.na(psi_temp) | (psi_temp < 0) | (psi_temp > 1)] <- NA"
"0",""
"0","    # Store quantiles"
"0","    results$psi_l[i]      <- quantile(psi_temp,  0.25, na.rm = TRUE)"
"0","    results$psi_median[i] <- quantile(psi_temp,  0.5,   na.rm = TRUE)"
"0","    results$psi_u[i]      <- quantile(psi_temp,  0.75, na.rm = TRUE)"
"0","  }"
"0","  return(results)"
"0","}"
"0",""
"0","df_ab_psi <- psi_mc(df_ab, 100000)"
"0","df_ab$psi_l <- df_ab_psi$psi_l"
"0","df_ab$psi_median <- df_ab_psi$psi_median"
"0","df_ab$psi_u <- df_ab_psi$psi_u"
"0","df_pcr_psi <- psi_mc(df_pcr, 100000)"
"0","df_pcr$psi_l <- df_pcr_psi$psi_l"
"0","df_pcr$psi_median <- df_pcr_psi$psi_median"
"0","df_pcr$psi_u <- df_pcr_psi$psi_u"
"0","# For Pathela et al."
"0","## We assume that infection due to other conditions is rare"
"0","df_menachemi <- df_pcr[3,]"
"0",""
"0","psi_mc_menachemi <- function(data, n_iter) {"
"0","  # Pre-allocate output"
"0","  n_rows <- nrow(data)"
"0","  results <- data.frame("
"0","    study = data$study,"
"0","    psi_l = NA_real_,"
"0","    psi_median = NA_real_,"
"0","    psi_u = NA_real_"
"0","  )"
"0","  "
"0","  # Vectorized Monte Carlo per-row"
"0","  for (i in 1:n_rows) {"
"0","    # Vectorized sampling"
"0","    alpha <- rbeta(n_iter, data$alpha_a[i], data$alpha_b[i])"
"0","    beta  <- rbeta(n_iter, data$beta_a[i],  data$beta_b[i])"
"0","    # beta = 1"
"0","    rho_c <- rbinom(n_iter, data$n[i],    data$rho_c[i]) / data$n[i]"
"0","    psi_c <- rbinom(n_iter, data$sp[i],   data$psi_c[i]) / data$sp[i]"
"0",""
"0","    # Calculations (all vectorized)"
"0","    rho_temp <- (rho_c + beta - 1) / (alpha + beta - 1)"
"0","    psi_temp <- 1 - rho_c*(1 - psi_c)/(alpha*rho_temp)"
"0","    psi_temp[is.na(psi_temp) | (psi_temp < 0) | (psi_temp > 1)] <- NA"
"0",""
"0","    # Store quantiles"
"0","    results$psi_l[i]      <- quantile(psi_temp,  0.25, na.rm = TRUE)"
"0","    results$psi_median[i] <- quantile(psi_temp,  0.5,   na.rm = TRUE)"
"0","    results$psi_u[i]      <- quantile(psi_temp,  0.75, na.rm = TRUE)"
"0","  }"
"0","  return(results)"
"0","}"
"0",""
"0","df_psi_menachemi <- psi_mc_menachemi(df_menachemi, 100000)"
"0","df_pcr$psi_l[3] <- df_psi_menachemi$psi_l"
"0","df_pcr$psi_median[3] <- df_psi_menachemi$psi_median"
"0","df_pcr$psi_u[3] <- df_psi_menachemi$psi_u"
"0","# df_pcr <- cbind(df_pcr, df_psi_menachemi)"
"0",""
